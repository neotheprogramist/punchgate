networks:
  public:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/24
  lan-a:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.1.0/24
  lan-b:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.2.0/24

services:
  nat-a:
    image: alpine:3.21
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      public:
        ipv4_address: 10.100.0.11
      lan-a:
        ipv4_address: 10.0.1.2
    volumes:
      - ./scripts/nat-entrypoint.sh:/nat-entrypoint.sh:ro
    environment:
      NAT_PUBLIC_SUBNET: "10.100.0"
      NAT_LAN_SUBNET: "10.0.1"
      NAT_PEER_IP: "10.0.1.30"
    command: /bin/sh /nat-entrypoint.sh

  nat-b:
    image: alpine:3.21
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      public:
        ipv4_address: 10.100.0.12
      lan-b:
        ipv4_address: 10.0.2.2
    volumes:
      - ./scripts/nat-entrypoint.sh:/nat-entrypoint.sh:ro
    environment:
      NAT_PUBLIC_SUBNET: "10.100.0"
      NAT_LAN_SUBNET: "10.0.2"
      NAT_PEER_IP: "10.0.2.40"
    command: /bin/sh /nat-entrypoint.sh

  echo:
    image: python:3-alpine
    networks:
      lan-a:
        ipv4_address: 10.0.1.20
    volumes:
      - ./scripts/echo_server.py:/echo_server.py:ro
    command: python3 /echo_server.py --host 0.0.0.0 --port 7777

  bootstrap:
    build:
      context: .
      dockerfile: Containerfile.e2e
      args:
        FEATURES: "--no-default-features"
    networks:
      public:
        ipv4_address: 10.100.0.10
    environment:
      PUNCHGATE_LISTEN: "/ip4/0.0.0.0/udp/4001/quic-v1"

  workhorse:
    build:
      context: .
      dockerfile: Containerfile.e2e
      args:
        FEATURES: "--no-default-features"
    cap_add:
      - NET_ADMIN
    depends_on:
      - echo
      - bootstrap
      - nat-a
    networks:
      lan-a:
        ipv4_address: 10.0.1.30
    environment:
      PUNCHGATE_LISTEN: "/ip4/0.0.0.0/udp/4001/quic-v1"
      PUNCHGATE_BOOTSTRAP: "/ip4/10.100.0.10/udp/4001/quic-v1/p2p/${BOOTSTRAP_ID}"
      PUNCHGATE_EXPOSE: "echo=10.0.1.20:7777"
      PUNCHGATE_GATEWAY: "10.0.1.2"
      RUST_LOG: "cli=info"

  client:
    build:
      context: .
      dockerfile: Containerfile.e2e
      args:
        FEATURES: "--no-default-features"
    cap_add:
      - NET_ADMIN
    depends_on:
      - workhorse
      - nat-b
    networks:
      lan-b:
        ipv4_address: 10.0.2.40
    environment:
      PUNCHGATE_LISTEN: "/ip4/0.0.0.0/udp/4001/quic-v1"
      PUNCHGATE_BOOTSTRAP: "/ip4/10.100.0.10/udp/4001/quic-v1/p2p/${BOOTSTRAP_ID}"
      PUNCHGATE_TUNNEL_BY_NAME: "echo@0.0.0.0:2222"
      PUNCHGATE_GATEWAY: "10.0.2.2"
      RUST_LOG: "cli=info"

  test-probe:
    image: alpine:3.21
    depends_on:
      - client
    networks:
      lan-b:
        ipv4_address: 10.0.2.50
    command: sleep infinity
